<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
    <title>Read Only by HTML5 UP</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="assets/css/main.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
</head>

<body>
    <!-- Header -->
    <section id="header">
        <header>
            <span class="image avatar"><img src="images/avatar.png" alt="" /></span>
            <h1 id="logo"><a href="#">Node + PassportJS</a></h1>
            <p>Easy authentication your NodeJS apps with PassportJS</p>
        </header>
        <nav id="nav">
            <ul>
                <li><a href="#intro" class="active">Introduction</a></li>
                <li><a href="#passportjs">PassportJS</a></li>
                <li><a href="#oauth">OAuth</a></li>
                <li><a href="#demo">Demo</a></li>
                <li><a href="#writing-app">Writing your own app</a></li>
            </ul>
        </nav>
        <footer>
            Luis PÃ©rez - lperez@avenuecode.com
            <br/> Pedro Dias - pdias@avenuecode.com
        </footer>
    </section>
    <!-- Wrapper -->
    <div id="wrapper">
        <!-- Main -->
        <div id="main">
            <!-- One -->
            <section id="intro">
                <div class="container">
                    <header class="major">
                        <h2>NodeJS + PassportJS</h2>
                        <p>Simple, unobtrusive authentication for Node.js.</p>
                        <ul>
                            <li><a href="http://passportjs.org/">Passportjs.org</a></li>
                            <li><a href="https://github.com/xilenomg/node-passportjs">https://github.com/xilenomg/node-passportjs</a></li>
                        </ul>
                    </header>
                    <p></p>
                </div>
            </section>
            <!-- Two -->
            <section id="passportjs">
                <div class="container">
                    <h3>PassportJS</h3>
                    <section>
                        <h4>Overview</h4>
                        <p>Passport is authentication middleware for Node.js. Extremely flexible and modular, Passport can be unobtrusively dropped in to any Express-based web application.</p>
                        <p>It is designed to serve a singular purpose: authenticate requests. In modern web applications, authentication can take a variety of forms. Traditionally, users log in by providing a username and password. With the rise of social networking, single sign-on using an OAuth provider such as Facebook or Twitter has become a popular authentication method. Services that expose an API often require token-based credentials to protect access.</p>
                        <p>Passport recognizes that each application has unique authentication requirements. Authentication mechanisms, known as <strong>strategies</strong>, are packaged as individual modules. Applications can choose which strategies to employ, without creating unnecessary dependencies.</p>
                    </section>
                    <section>
                        <h4>Strategies</h4>
                        <p>Passport uses what are termed strategies to authenticate requests. Strategies range from verifying a username and password, delegated authentication using OAuth or federated authentication using OpenID. Before asking Passport to authenticate a request, the strategy (or strategies) used by an application must be configured.</p>
                        <p>In this training, we will use four of the most common strategies</p>
                        <ul>
                            <li>Local</li>
                            <li>Facebook</li>
                            <li>Google</li>
                            <li>Twitter</li>
                        </ul>
                        <p>Facebook, Google and Twitter implement the OAuth standard for authorization, which we will take a look in the next section.</p>
                    </section>
                    <p></p>
                </div>
            </section>
            <!-- Three -->
            <section id="oauth">
                <div class="container">
                    <h3>OAuth</h3>
                    <section>
                        <h4>Definition</h4>
                        <p>An open protocol to allow secure authorization in a simple standard method from web, mobile and desktop applications.</p>
                        <p>Also known as Authorization Framework</p>
                    </section>
                    <section>
                        <h4>Roles</h4>
                        <ul>
                            <li>Resource owner</li>
                            <li>Client</li>
                            <li>Resource server</li>
                            <li>Authorization server</li>
                        </ul>
                        <ol>
                            <li><strong>Resource owner:</strong> User<p>The resource owner is the user who authorizes an application to access their account. The application's access to the user's account is limited to the "scope" of the authorization granted (e.g. read or write access).</p></li>
                            <li><strong>Client:</strong> Application<p>The client is the application that wants to access the user's account. Before it may do so, it must be authorized by the user, and the authorization must be validated by the API.</p></li>
                            <li><strong>Resource server/Authorization server:</strong> API<p>The resource server hosts the protected user accounts, and the authorization server verifies the identity of the user then issues access tokens to the application. From an application developer's point of view, a service's API fulfills both the resource and authorization server roles.</p></li>
                        </ol>
                    </section>
                    <section>
                        <h4>Flow</h4>
                        <p>Now that you have an idea of what the OAuth roles are, let's look at a diagram of how they generally interact with each other:</p>
                        <p><img src="https://assets.digitalocean.com/articles/oauth/abstract_flow.png"></p>
                        <p>Here is a more detailed explanation of the steps in the diagram:</p>
                        <ol>
                            <li>The <em>application</em> requests authorization to access service resources from the <em>user</em></li>
                            <li>If the <em>user</em> authorized the request, the <em>application</em> receives an authorization grant</li>
                            <li>The <em>application</em> requests an access token from the <em>authorization server</em> (API) by presenting authentication of its own identity, and the authorization grant</li>
                            <li>If the application identity is authenticated and the authorization grant is valid, the <em>authorization server</em> (API) issues an access token to the application. Authorization is complete.</li>
                            <li>The <em>application</em> requests the resource from the <em>resource server</em> (API) and presents the access token for authentication</li>
                            <li>If the access token is valid, the <em>resource server</em> (API) serves the resource to the <em>application</em></li>
                        </ol>
                        <p>The actual flow of this process will differ depending on the authorization grant type in use, but this is the general idea. We will explore different grant types in a later section.</p>
                    </section>
                </div>
            </section>

            <!-- Four -->
            <section id="demo">
                <div class="container">
                    <h3>Demo</h3>
                    <video id="sampleMovie" width="640" height="360" preload controls>
                        <source src="assets/video/demo.mov" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"' />
                        <object type="application/x-shockwave-flash" data="http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf" width="640" height="360">
                            <param name="movie" value="http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf" />
                            <param name="allowFullScreen" value="true" />
                            <param name="wmode" value="transparent" />
                            <param name="flashvars" value='config={"clip":{"url":"assets/video/demo.mov","autoPlay":false,"autoBuffering":true}}' />
                        </object>
                    </video>
                </div>
            </section>
            <!-- Five -->
            <section id="writing-app">
                <div class="container">
                    <h3>Writing your own app</h3>
                    <section>
                        <h3>Setup</h3>
                        <ul>
                            <li>npm init</li>
                            <li>npm install bcrypt-nodejs body-parser connect-flash cookie-parser ejs express express-session method-override mongoose morgan passport passport-local passport-facebook passport-google-oauth passport-local passport-twitter --save</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Configuration Files</h3>
                        <h4>/config/auth.js</h4>
                        <pre><code>
// expose our config directly to our application using module.exports
module.exports = {};
						</code></pre>
                        <h4>/config/database.js</h4>
                        <pre><code>
module.exports = {
	'url': 'mongodb://localhost/node-passport'
}
						</code></pre>
                        <h4>/config/passport.js</h4>
                        <pre><code>
module.exports = function(passport) {}
						</code></pre>
                        <h4>/app/routes.js</h4>
                        <pre><code>
module.exports = function(passport) {}
                        </code></pre>
                    </section>
                    <section>
                        <h3>Index.js</h3>
                        <pre><code>
//libraries required
//express framework
var express = require('express');
var app = express();
//mongo connector
var mongoose = require('mongoose');
//Passport
var passport = require('passport');
//Flash messages stored in session
var flash = require('connect-flash');
//log request to the log
var morgan = require('morgan');
//read cookies
var cookieParser = require('cookie-parser');
//get information from html forms
var bodyParser = require('body-parser');
//session
var session = require('express-session');

var PORT = process.env.PORT || 8080;

//database
var databaseConfig = require('./config/database.js');
mongoose.connect(databaseConfig.url);

//passport
require('./config/passport')(passport);

//APP use
app.use(morgan('dev'));
app.use(cookieParser());
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true })); //Returns middleware that only parses urlencoded bodies. This parser accepts only UTF-8 encoding of the body and supports automatic inflation of gzip and deflate encodings.

//setup view
app.set('view engine', 'ejs');

//session setup
app.use(session({ secret: 'avenuecode-passport-training', resave: true, saveUninitialized: false }));
//secret - This is the secret used to sign the session ID cookie
//resave - Forces the session to be saved back to the session store, even if the session was never modified during the request. 
//saveUninitialized - Forces a session that is "uninitialized" to be saved to the store.
//https://www.npmjs.com/package/express-session

//passport setup
app.use(passport.initialize());
app.use(passport.session());

//flash message setup
app.use(flash());

//routes
require('./app/routes.js')(app, passport);

//listen to port
app.listen(PORT, function() {
    console.log("Open your browser at http://localhost:" + PORT);
});</code></pre>
                    </section>
                    <section>
                        <h3>Starting Server</h3>
                        <pre><code>$ mongod --dbpath ~/path/to/folder</code></pre>
                        <pre><code>$ node index  #nodemon index.js (npm install nodemon -g)</code></pre>
                    </section>
                    <section>
                        <h3>Model</h3>
                        <h4>/app/models/user.js</h4>
                        <pre><code>// load the things we need
var mongoose = require('mongoose');
var bcrypt   = require('bcrypt-nodejs');

// define the schema for our user model
var userSchema = mongoose.Schema({
    local            : {
        email        : String,
        password     : String
    },
    facebook         : {
        id           : String,
        token        : String,
        email        : String,
        name         : String
    },
    twitter          : {
        id           : String,
        token        : String,
        displayName  : String,
        username     : String
    },
    google           : {
        id           : String,
        token        : String,
        email        : String,
        name         : String
    }
});

// generating a hash
userSchema.methods.generateHash = function(password) {
    return bcrypt.hashSync(password, bcrypt.genSaltSync(8), null);
};

// checking if password is valid
userSchema.methods.validPassword = function(password) {
    return bcrypt.compareSync(password, this.local.password);
};

// create the model for users and expose it to our app
module.exports = mongoose.model('User', userSchema);

                        </code></pre>
                    </section>
                    <section>
                        <h3>Views</h3>
                        <h4>/views/header.ejs</h4>
                        <pre><code>
&lt;!Doctype html&gt;
&lt;html&gt;
&lt;head&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;Passport Authentication&lt;/title&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;link rel=&quot;stylesheet&quot; href=&quot;//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;link rel=&quot;stylesheet&quot; href=&quot;//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;style&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { padding-top:80px; }
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;container&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;jumbotron text-center&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;&lt;span class=&quot;fa fa-lock&quot;&gt;&lt;/span&gt; Passport Authentication&lt;/h1&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
</code></pre>
                        <h4>/views/footer.ejs</h4>
                        <pre><code>    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
                        <h4>/views/index.ejs</h4>
                        <pre><code>&lt;% include header %&gt;
&lt;% include footer %&gt;
</code></pre>
                    </section>
                    <section>
                        <h3>Render</h3>
                        <h4>/app/routes.js</h4>
                        <pre><code>var express = require('express');
var appRouter = express.Router();

module.exports = function(app, passport) {
    //normal Routes

    //index
    appRouter.get('/', function(request, response) {
        response.render('index.ejs');
    });

    app.use('/', appRouter);
};</code></pre>
                    </section>
                    <section>
                        <h3>Local Signup</h3>
                        <h4>/views/index.ejs</h4>
                        <pre><code>&lt;a href=&quot;/signup&quot; class=&quot;btn btn-default&quot;&gt;&lt;span class=&quot;fa fa-user&quot;&gt;&lt;/span&gt; Local Signup&lt;/a&gt;</code></pre>
                        <h4>/app/routes.js</h4>
                        <pre><code>appRouter.get('/signup', function(request, response) {
        response.render('signup.ejs', { message: request.flash('signupMessage') });
    });

    appRouter.post('/signup', passport.authenticate('local-signup', {
        // redirect to the secure profile section
        successRedirect: '/profile',
        // redirect back to the signup page if there is an error
        failureRedirect: '/signup',
        // allow flash messages
        failureFlash: true
    }));</code></pre>
                        <h4>/views/signup.ejs</h4>
                        <pre><code>&lt;% include header %&gt;

&lt;h1&gt;&lt;span class=&quot;fa fa-sign-in&quot;&gt;&lt;/span&gt; Signup&lt;/h1&gt;
&lt;!-- LOGIN FORM --&gt;
&lt;form action=&quot;/signup&quot; method=&quot;post&quot;&gt;
&lt;div class=&quot;form-group&quot;&gt;
&lt;label&gt;Email&lt;/label&gt;
&lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;email&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;form-group&quot;&gt;
&lt;label&gt;Password&lt;/label&gt;
&lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot;&gt;
&lt;/div&gt;

&lt;button type=&quot;submit&quot; class=&quot;btn btn-warning btn-lg&quot;&gt;Signup&lt;/button&gt;
&lt;/form&gt;

&lt;hr&gt;

&lt;p&gt;Already have an account? &lt;a href=&quot;/login&quot;&gt;Login&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Or go &lt;a href=&quot;/&quot;&gt;home&lt;/a&gt;.&lt;/p&gt;
&lt;% include footer %&gt;</code></pre>
                        <h4>/config/passport.js</h4>
                        <pre><code>
//Loading Strategies
var LocalStrategy = require('passport-local').Strategy;
// load up the user model
var User = require('../app/models/user');
// load the auth config
var configAuth = require('./auth');

module.exports = function(passport) {
    // used to serialize the user for the session
    passport.serializeUser(function(user, done) {
        done(null, user.id);
    });

    // used to deserialize the user
    passport.deserializeUser(function(id, done) {
        User.findById(id, function(err, user) {
            done(err, user);
        });
    });

passport.use('local-signup', new LocalStrategy({
            // by default, local strategy uses username and password, we will override with email
            usernameField: 'email',
            passwordField: 'password',
            passReqToCallback: true // allows us to pass in the req from our route (lets us check if a user is logged in or not)
        },
        function(request, email, password, done) {
            if (email)
                email = email.toLowerCase(); // Use lower-case e-mails to avoid case-sensitive e-mail matching

            // asynchronous
            process.nextTick(function() {
                // if the user is not already logged in:
                if (!request.user) {
                    User.findOne({ 'local.email': email }, function(err, user) {
                        // if there are any errors, return the error
                        if (err) {
                            return done(err);
                        }

                        // check to see if theres already a user with that email
                        if (user) {
                            // return console.log('That email is already taken.');
                            return done(null, false, request.flash('signupMessage', 'That email is already taken.'));
                        } else {

                            // create the user
                            var newUser = new User();

                            newUser.local.email = email;
                            newUser.local.password = newUser.generateHash(password);

                            newUser.save(function(err) {
                                if (err) {
                                    return done(err);
                                }

                                return done(null, newUser);
                            });
                        }

                    });
                    // if the user is logged in but has no local account...
                } else {
                    // user is logged in and already has a local account. Ignore signup. (You should log out before trying to create a new account, user!)
                    return done(null, request.user);
                }

            });

        }));
};</code></pre>
                        <h4>/app/routes.js</h4>
                        <pre><code>
appRouter.get('/', function(request, response) {
    response.render('index.ejs');
});</code></pre>
                    </section>
                    <section>
                        <h3>Local Login</h3>
                        <h4>/views/index.ejs</h4>
                        <pre><code>&lt;a href=&quot;/login&quot; class=&quot;btn btn-default&quot;&gt;&lt;span class=&quot;fa fa-user&quot;&gt;&lt;/span&gt; Local Login&lt;/a&gt;</code></pre>
                        <h4>/views/login.ejs</h4>
                        <pre><code>
&lt;% include header %&gt;
&lt;h1&gt;&lt;span class=&quot;fa fa-sign-in&quot;&gt;&lt;/span&gt; Login&lt;/h1&gt;
&lt;% if (message.length &gt; 0) { %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;alert alert-danger&quot;&gt;&lt;%= message %&gt;&lt;/div&gt;
&lt;% } %&gt;

&lt;!-- LOGIN FORM --&gt;
&lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;form-group&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;label&gt;Email&lt;/label&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;email&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;form-group&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;label&gt;Password&lt;/label&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;

&nbsp;&nbsp;&nbsp;&nbsp;&lt;button type=&quot;submit&quot; class=&quot;btn btn-warning btn-lg&quot;&gt;Login&lt;/button&gt;
&lt;/form&gt;

&lt;hr&gt;

&lt;p&gt;Need an account? &lt;a href=&quot;/signup&quot;&gt;Signup&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Or go &lt;a href=&quot;/&quot;&gt;home&lt;/a&gt;.&lt;/p&gt;
&lt;% include footer %&gt;</code></pre>
                        <h4>/app/routes.js</h4>
                        <pre><code>appRouter.get('/login', function(request, response) {
    response.render('login.ejs', { message: request.flash('loginMessage') });
});

//process login form
appRouter.post('/login', passport.authenticate('local-login', {
    // redirect to the secure profile section
    successRedirect: '/profile',
    // redirect back to the signup page if there is an error
    failureRedirect: '/login',
    // allow flash messages
    failureFlash: true
}));
</code></pre>
                        <h4>/config/passport.js</h4>
                        <pre><code>//Local login
passport.use('local-login', new LocalStrategy({
        // by default, local strategy uses username and password, we will override with email
        usernameField: 'email',
        passwordField: 'password',
        passReqToCallback: true // allows us to pass in the req from our route (lets us check if a user is logged in or not)
    },
    function(request, email, password, done) {
        if (email) {
            email = email.toLowerCase(); // Use lower-case e-mails to avoid case-sensitive e-mail matching
        }

        // asynchronous
        process.nextTick(function() {
            User.findOne({ 'local.email': email }, function(err, user) {
                // if there are any errors, return the error
                if (err)
                    return done(err);

                // no user found
                if (!user){
                    // return console.log('No user found.');
                    return done(null, false, request.flash('loginMessage', 'No user found.'));
                }

                // invalid password
                if (!user.validPassword(password)){
                    return done(null, false, request.flash('loginMessage', 'Invalid password.'));
                    // return console.log('Invalid password');
                }

                // all is well, return user
                else
                    return done(null, user);
            });
        });
    }));</code></pre>
                    </section>
                    <section>
                        <h3>Profile</h3>
                        <h4>/views/profile.ejs</h4>
                        <pre><code>&lt;% include header %&gt;
&lt;div class=&quot;page-header text-center&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;&lt;span class=&quot;fa fa-anchor&quot;&gt;&lt;/span&gt; Profile Page&lt;/h1&gt;
&lt;/div&gt;
&lt;div class=&quot;row&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- LOCAL INFORMATION --&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;col-sm-6&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;well&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h3&gt;&lt;span class=&quot;fa fa-user&quot;&gt;&lt;/span&gt; Local&lt;/h3&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% if (user.local.email) { %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;id&lt;/strong&gt;: &lt;%= user._id %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;email&lt;/strong&gt;: &lt;%= user.local.email %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;password&lt;/strong&gt;: &lt;%= user.local.password %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% } %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&lt;/div&gt;
&lt;% include footer %&gt;</code></pre>
                        <h4>/app/routes.js</h4>
                        <pre><code>appRouter.get('/profile', isLoggedIn, function(request, response) {
	response.render('profile.ejs', {
	    user: request.user
	});
});

</code></pre>

<pre><code>//middleware that will verify whether user is logged in
var isLoggedIn = function(request, response, next) {
    if (request.isAuthenticated()) {
        return next();
    }
    response.redirect('/');
}
</code></pre>
                    </section>
                    <section>
                        <h3>Logout</h3>

                        <h4>/views/profile.ejs</h4>
                        <pre><code>&lt;a href=&quot;/logout&quot; class=&quot;btn btn-default btn-sm&quot;&gt;Logout&lt;/a&gt;</code></pre>

                        <h4>/app/routes.js</h4>
                        <pre><code>appRouter.get('/logout', function(request, response) {
    request.logout();
    response.redirect('/');
});</code>
                    </section>
                    <section>
                        <h3>Facebook</h3>
                        <h4>/views/home.ejs</h4>
<pre><code>&lt;a href=&quot;/auth/facebook&quot; class=&quot;btn btn-primary&quot;&gt;&lt;span class=&quot;fa fa-facebook&quot;&gt;&lt;/span&gt; Facebook&lt;/a&gt;</code></pre>
							
						<a target="_blank" href="https://developers.facebook.com/">https://developers.facebook.com/</a><br /><br />

						<h4>/config/auth.js</h4>
						<pre><code>'facebookAuth': {
    'clientID': '1675914896001421',
    'clientSecret': '7fe0217711792f908161a1efb4711842',
    'callbackURL': 'http://localhost:8080/auth/facebook/callback'
}</code></pre>

<h4>/app/routes.js</h4>
<pre><code>var authRouter = express.Router();

module.exports ...
//facebook
//scopes: https://developers.facebook.com/docs/facebook-login/permissions
authRouter.get('/facebook', passport.authenticate('facebook', { scope: 'email' }));

authRouter.get('/facebook/callback', passport.authenticate('facebook', {
    successRedirect: '/profile',
    failureRedirect: '/'
}));
app.use('/auth', authRouter);</code></pre>

<h4>/app/routes.js</h4>
<pre><code>var FacebookStrategy = require('passport-facebook').Strategy;</code></pre>
<pre><code>//facebook
passport.use(new FacebookStrategy({
        clientID: configAuth.facebookAuth.clientID,
        clientSecret: configAuth.facebookAuth.clientSecret,
        callbackURL: configAuth.facebookAuth.callbackURL,
        profileFields: ['id', 'name', 'email'],
        passReqToCallback: true // allows us to pass in the req from our route (lets us check if a user is logged in or not)
    },
    function(request, token, refreshToken, profile, done) {
        // asynchronous
        process.nextTick(function() {
            // check if the user is already logged in
            if (!request.user) {
                User.findOne({ 'facebook.id': profile.id }, function(err, user) {
                    if (err) {
                        return done(err);
                    }
                    if (user) {
                        // if there is a user id already but no token (user was linked at one point and then removed)
                        if (!user.facebook.token) {
                            user.facebook.token = token;
                            user.facebook.name = profile.name.givenName + ' ' + profile.name.familyName;
                            user.facebook.email = (profile.emails[0].value || '').toLowerCase();
                            user.save(function(err) {
                                if (err) {
                                    return done(err);
                                }
                                return done(null, user);
                            });
                        }
                        return done(null, user); // user found, return that user
                    } else {
                        // if there is no user, create them
                        var newUser = new User();
                        newUser.facebook.id = profile.id;
                        newUser.facebook.token = token;
                        newUser.facebook.name = profile.name.givenName + ' ' + profile.name.familyName;
                        newUser.facebook.email = (profile.emails[0].value || '').toLowerCase();
                        newUser.save(function(err) {
                            if (err) {
                                return done(err);
                            }
                            return done(null, newUser);
                        });
                    }
                });
            }
        });
    }));</code></pre>

<h4>views/profile.ejs</h4>
    <pre><code>&lt;!-- FACEBOOK INFORMATION --&gt;
&lt;div class=&quot;col-sm-6&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;well&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h3 class=&quot;text-primary&quot;&gt;&lt;span class=&quot;fa fa-facebook&quot;&gt;&lt;/span&gt; Facebook&lt;/h3&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- check if the user has this token (is the user authenticated with this social account) --&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% if (user.facebook.token) { %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;id&lt;/strong&gt;: &lt;%= user.facebook.id %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;token&lt;/strong&gt;: &lt;%= user.facebook.token %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;email&lt;/strong&gt;: &lt;%= user.facebook.email %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;name&lt;/strong&gt;: &lt;%= user.facebook.name %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% } %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&lt;/div&gt;</code></pre>
                    </section>
                    <section>
                        <h3>Twitter</h3>
                        <h4>/views/index.ejs</h4>
                        <pre><code>&lt;a href=&quot;/auth/twitter&quot; class=&quot;btn btn-info&quot;&gt;&lt;span class=&quot;fa fa-twitter&quot;&gt;&lt;/span&gt; Twitter&lt;/a&gt;</code></pre>

                        <a target="_blank" href="https://dev.twitter.com/">https://dev.twitter.com/</a><br /><br />

                        <h4>/config/auth.js</h4>
                        <pre><code>//https://dev.twitter.com/
'twitterAuth': {
    'consumerKey': 'CJWOXklHh2iJLdX8OeXBatd7G',
    'consumerSecret': 'ZdoOupziT1PIJykk6iPLMM3ud8yBlgg3Wxp7GVMU4UAMvHKqU3',
    'callbackURL': 'http://localhost:8080/auth/twitter/callback'
},</code></pre>
                        

                        <h4>/app/routes.js</h4>
                        <pre><code>//twitter
authRouter.get('/twitter', passport.authenticate('twitter', { scope: 'email' }));

authRouter.get('/twitter/callback', passport.authenticate('twitter', {
    successRedirect: '/profile',
    failureRedirect: '/'
}));</code></pre>


                        <h4>/config/passport.js</h4>
                        <pre><code>var TwitterStrategy = require('passport-twitter').Strategy;</code></pre>
                        <pre><code>//twitter
passport.use(new TwitterStrategy({
        consumerKey: configAuth.twitterAuth.consumerKey,
        consumerSecret: configAuth.twitterAuth.consumerSecret,
        callbackURL: configAuth.twitterAuth.callbackURL,
        passReqToCallback: true // allows us to pass in the req from our route (lets us check if a user is logged in or not)
    },
    function(request, token, tokenSecret, profile, done) {
        // asynchronous
        process.nextTick(function() {
            // check if the user is already logged in
            if (!request.user) {
                User.findOne({ 'twitter.id': profile.id }, function(err, user) {
                    if (err) {
                        return done(err);
                    }
                    if (user) {
                        // if there is a user id already but no token (user was linked at one point and then removed)
                        if (!user.twitter.token) {
                            user.twitter.token = token;
                            user.twitter.username = profile.username;
                            user.twitter.displayName = profile.displayName;
                            user.save(function(err) {
                                if (err) {
                                    return done(err);
                                }
                                return done(null, user);
                            });
                        }
                        return done(null, user); // user found, return that user
                    } else {
                        // if there is no user, create them
                        var newUser = new User();
                        newUser.twitter.id = profile.id;
                        newUser.twitter.token = token;
                        newUser.twitter.username = profile.username;
                        newUser.twitter.displayName = profile.displayName;
                        newUser.save(function(err) {
                            if (err) {
                                return done(err);
                            }
                            return done(null, newUser);
                        });
                    }
                });
            } 
        });
    }));</code></pre>

    <h4>/views/profile.ejs</h4>
    <pre><code>&lt;div class=&quot;row&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- TWITTER INFORMATION --&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;col-sm-6&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;well&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h3 class=&quot;text-info&quot;&gt;&lt;span class=&quot;fa fa-twitter&quot;&gt;&lt;/span&gt; Twitter&lt;/h3&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% if (user.twitter.token) { %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;id&lt;/strong&gt;: &lt;%= user.twitter.id %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;token&lt;/strong&gt;: &lt;%= user.twitter.token %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;display name&lt;/strong&gt;: &lt;%= user.twitter.displayName %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;username&lt;/strong&gt;: &lt;%= user.twitter.username %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% } %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&lt;/div&gt;</code></pre>
                    </section>
                    <section>
                        <h3>Google</h3>
                        <h4>/views/index.ejs</h4>
                        <pre><code>&lt;a href=&quot;/auth/google&quot; class=&quot;btn btn-danger&quot;&gt;&lt;span class=&quot;fa fa-google-plus&quot;&gt;&lt;/span&gt; Google+&lt;/a&gt;</code></pre>

                          <a target="_blank" href="https://dev.twitter.com/">https://dev.twitter.com/</a><br /><br />


                        <h4>/config/auth.js</h4>
                        <pre><code>//console.developer.google.com or https://console.cloud.google.com
'googleAuth': {
    'clientID': '87668141240-tiqv5uie7i0oe8nq2tlrr10qu6jkd1pa.apps.googleusercontent.com',
    'clientSecret': 'r8wDnKBQfnAP9LvmZG4cJQ87',
    'callbackURL': 'http://localhost:8080/auth/google/callback'
}</code></pre>

                        
                        <h4>/app/routes.js</h4>
                        <pre><code>//google
authRouter.get('/google', passport.authenticate('google', { scope: ['profile', 'email'] }));

authRouter.get('/google/callback', passport.authenticate('google', {
    successRedirect: '/profile',
    failureRedirect: '/'
}));</code></pre>

                        
                        <h4>/config/passport.js</h4>
                        <pre><code>var GoogleStrategy = require('passport-google-oauth').OAuth2Strategy;</code></pre>
                        
                        <pre><code>//Google
passport.use(new GoogleStrategy({
    clientID        : configAuth.googleAuth.clientID,
    clientSecret    : configAuth.googleAuth.clientSecret,
    callbackURL     : configAuth.googleAuth.callbackURL,
    passReqToCallback : true // allows us to pass in the req from our route (lets us check if a user is logged in or not)
},
function(request, token, refreshToken, profile, done) {
    // asynchronous
    process.nextTick(function() {
        // check if the user is already logged in
        if (!request.user) {
            User.findOne({ 'google.id' : profile.id }, function(err, user) {
                if (err)
                    return done(err);
                if (user) {
                    // if there is a user id already but no token (user was linked at one point and then removed)
                    if (!user.google.token) {
                        user.google.token = token;
                        user.google.name  = profile.displayName;
                        user.google.email = (profile.emails[0].value || '').toLowerCase(); // pull the first email
                        user.save(function(err) {
                            if (err){
                                return done(err);
                            }
                            return done(null, user);
                        });
                    }
                    return done(null, user);
                } else {
                    var newUser          = new User();
                    newUser.google.id    = profile.id;
                    newUser.google.token = token;
                    newUser.google.name  = profile.displayName;
                    newUser.google.email = (profile.emails[0].value || '').toLowerCase(); // pull the first email
                    newUser.save(function(err) {
                        if (err){
                            return done(err);
                        }
                        return done(null, newUser);
                    });
                }
            });
        }
    });
}));</code></pre>



                        <h4>/views/profile.js</h4>
                        <pre><code>&lt;!-- GOOGLE INFORMATION --&gt;
&lt;div class=&quot;col-sm-6&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;well&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h3 class=&quot;text-danger&quot;&gt;&lt;span class=&quot;fa fa-google-plus&quot;&gt;&lt;/span&gt; Google+&lt;/h3&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% if (user.google.token) { %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;id&lt;/strong&gt;: &lt;%= user.google.id %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;token&lt;/strong&gt;: &lt;%= user.google.token %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;email&lt;/strong&gt;: &lt;%= user.google.email %&gt;&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;strong&gt;name&lt;/strong&gt;: &lt;%= user.google.name %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;% }%&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&lt;/div&gt;</code></pre>
                    </section>
                    


                    <section>
                        <h3>Link Account Local</h3>
                        <h4>/views/profile.js</h4>
                        <pre><code><% } else { %>
    &lt;a href=&quot;/connect/local&quot; class=&quot;btn btn-default&quot;&gt;Connect Local&lt;/a&gt;
<% } %></code></pre>


                        <h4>/app/routes.js</h4>
                        <pre><code>var connectRouter = express.Router();</code></pre>

                        <pre><code>//local
connectRouter.get('/local', function(request, response) {
    response.render('connect-local.ejs', { message: request.flash('loginMessage') });
});
connectRouter.post('/local', passport.authenticate('local-signup', {
    successRedirect: '/profile', // redirect to the secure profile section
    failureRedirect: '/connect/local', // redirect back to the signup page if there is an error
    failureFlash: true // allow flash messages
}));

app.use('/connect', connectRouter);
</code></pre>


                        <h4>/config/passport.js</h4>
                        <pre><code>else if (!request.user.local.email) {
    //let's check if the email used to connect a local account is being used by another user
    User.findOne({ 'local.email': email }, function(err, user) {
        if (err) {
            return done(err);
        }

        if (user) {
            // return console.log('That email is already taken.');
            return done(null, false, request.flash('loginMessage', 'That email is already taken.'));
            // Using 'loginMessage instead of signupMessage because it's used by /connect/local'
        } else {
            var user = request.user;
            user.local.email = email;
            user.local.password = user.generateHash(password);
            user.save(function(err) {
                if (err) {
                    return done(err);
                }
                return done(null, user);
            });
        }
    });
}</code></pre>


                        <h4>/views/connect-local.ejs</h4>
                        <pre><code>
&lt;% include header %&gt;
&lt;h1&gt;&lt;span class=&quot;fa fa-user&quot;&gt;&lt;/span&gt; Add Local Account&lt;/h1&gt;
&lt;% if (message.length &gt; 0) { %&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;alert alert-danger&quot;&gt;&lt;%= message %&gt;&lt;/div&gt;
&lt;% } %&gt;
&lt;!-- LOGIN FORM --&gt;
&lt;form action=&quot;/connect/local&quot; method=&quot;post&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;form-group&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;label&gt;Email&lt;/label&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;email&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=&quot;form-group&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;label&gt;Password&lt;/label&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;button type=&quot;submit&quot; class=&quot;btn btn-warning btn-lg&quot;&gt;Add Local&lt;/button&gt;
&lt;/form&gt;
&lt;hr&gt;
&lt;p&gt;&lt;a href=&quot;/profile&quot;&gt;Go back to profile&lt;/a&gt;&lt;/p&gt;
&lt;% include footer %&gt;</code></pre>

                    </section>
                    <section>
                        <h3>Link Account Facebook</h3>

                        <h4>/views/profile.js</h4>
                        <pre><code><% } else { %>
    &lt;a href=&quot;/connect/facebook&quot; class=&quot;btn btn-primary&quot;&gt;Connect Facebook&lt;/a&gt;
<% } %>
</code></pre>


                        <h4>/app/routes.js</h4>
                        <pre><code>connectRouter.get('/facebook', passport.authorize('facebook', { scope: 'email' }));

connectRouter.get('/facebook/callback',
    passport.authorize('facebook', {
        successRedirect: '/profile',
        failureRedirect: '/'
    }));</code></pre>


                        <h4>/config/passport.js</h4>
                        <pre><code>else {
    // user already exists and is logged in, we have to link accounts
    var user = request.user; // pull the user out of the session

    user.facebook.id = profile.id;
    user.facebook.token = token;
    user.facebook.name = profile.name.givenName + ' ' + profile.name.familyName;
    user.facebook.email = (profile.emails[0].value || '').toLowerCase();

    user.save(function(err) {
        if (err) {
            return done(err);
        }

        return done(null, user);
    });

}</code></pre>
                    </section>
                    <section>
                        <h3>Link Account Twitter</h3>
                        <h4>/views/profile.js</h4>
                        <pre><code><% } else { %>
    &lt;a href=&quot;/connect/twitter&quot; class=&quot;btn btn-info&quot;&gt;Connect Twitter&lt;/a&gt;
<% } %></code></pre>


                        <h4>/app/routes.js</h4>
                        <pre><code>//Twitter
connectRouter.get('/twitter', passport.authorize('twitter', { scope: 'email' }));

// handle the callback after twitter has authorized the user
connectRouter.get('/twitter/callback',
    passport.authorize('twitter', {
        successRedirect: '/profile',
        failureRedirect: '/'
    }));</code></pre>


                        <h4>/config/passport.js</h4>
                        <pre><code>else {
    // user already exists and is logged in, we have to link accounts
    var user = request.user; // pull the user out of the session

    user.twitter.id = profile.id;
    user.twitter.token = token;
    user.twitter.username = profile.username;
    user.twitter.displayName = profile.displayName;

    user.save(function(err) {
        if (err) {
            return done(err);
        }

        return done(null, user);
    });
}</code></pre>
                    </section>
                    <section>
                        <h3>Link Account Google</h3>


                        <h4>/views/profile.js</h4>
                        <pre><code><% } else { %>
    &lt;a href=&quot;/connect/google&quot; class=&quot;btn btn-danger&quot;&gt;Connect Google&lt;/a&gt;
<% } %></code></pre>


                        <h4>/app/routes.js</h4>
                        <pre><code>//Google
connectRouter.get('/google', passport.authorize('google', { scope: ['profile', 'email'] }));

// the callback after google has authorized the user
connectRouter.get('/google/callback',
    passport.authorize('google', {
        successRedirect: '/profile',
        failureRedirect: '/'
    }));</code></pre>


                        <h4>/config/passport.js</h4>
                        <pre><code>else {
    // user already exists and is logged in, we have to link accounts
    var user               = request.user; // pull the user out of the session
    user.google.id    = profile.id;
    user.google.token = token;
    user.google.name  = profile.displayName;
    user.google.email = (profile.emails[0].value || '').toLowerCase(); // pull the first email
    user.save(function(err) {
        if (err){
            return done(err);
        }
        return done(null, user);
    });
}</code></pre>


                    </section>
                    <section>
                        <h3>Unlink Accounts</h3>
                        <h4>/config/routes.js</h4>
                        <pre><code>var unlinkRouter = express.Router();</code></pre>
                        <pre><code>//local
unlinkRouter.get('/local', function(request, response) {
    var user            = request.user;
    user.local.email    = undefined;
    user.local.password = undefined;
    user.save(function(err) {
        response.redirect('/profile');
    });
});
</code></pre>
<pre><code>//facebook
unlinkRouter.get('/facebook', function(request, response) {
    var user            = request.user;
    user.facebook.token = undefined;
    user.save(function(err) {
        response.redirect('/profile');
    });
});
</code></pre>
<pre><code>//twitter
unlinkRouter.get('/twitter', function(request, response) {
    var user           = request.user;
    user.twitter.token = undefined;
    user.save(function(err) {
       response.redirect('/profile');
    });
});
</code></pre>
<pre><code>//google
unlinkRouter.get('/google', function(request, response) {
    var user          = request.user;
    user.google.token = undefined;
    user.save(function(err) {
       response.redirect('/profile');
    });
});

</code></pre>
<pre><code>app.use('/unlink', unlinkRouter);</code></pre>
                    </section>
                    <section>
                        <h3>End</h3>
                    </section>
                </div>
            </section>
        </div>
        <!-- Footer -->
        <section id="footer">
            <div class="container">
                <ul class="copyright">
                    <li>&copy; Untitled. All rights reserved.</li>
                    <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                </ul>
            </div>
        </section>
    </div>
    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrollzer.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/skel.min.js"></script>
    <script src="assets/js/util.js"></script>
    <!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
    <script src="assets/js/main.js"></script>
</body>

</html>
